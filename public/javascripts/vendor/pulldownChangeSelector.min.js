!function(t){"use strict";t.fn.pulldownChangeSelector=function(e){var n,s,i,o,l,a,g,r,p,c,d,u,m,E,h,y={citytown:[],citytownstore:[]};if(0===this.length)return this;if(this.length>1)return this.each(function(){t(this).pulldownChangeSelector(e)}),this;n=this;var f={};return s={debug:!1,city:"select:eq(0)",town:"select:eq(1)",zip:null,store:null,cityElement:null,townElement:null,zipElement:null,storeElement:null,storeType:!1,island:"data",onReady:function(){return!0},onChange:function(){return!0},errorString:{groupStart:"pulldownChangeSelector package debug log (%s)",noElement:"can not get element (%s)",noConnect:"can not connect to api"}},f.settings=t.extend({},s,e),f.settings.debug&&console.group(f.settings.errorString.groupStart,n.prop("tagName")+"."+n.attr("class").replace(/ /g,".")),i=t('meta[name="env"]').attr("content")?t('meta[name="env"]').attr("content"):"dev",l=f.settings.storeType===!1?"citytown":"citytownstore",o={dev:{citytown:"/public/apis/API_taiwan_area.json",citytownstore:"/public/apis/APP_SenaoOnlineStore_type2.json"},lab:{citytown:"//m.senao.com.tw/apis/senao_online/EC_S3Resource.jsp?apiKey=API_taiwan_area.json",citytownstore:"//m.senao.com.tw/apis/senao_online/EC_S3Resource.jsp?apiKey=APP_SenaoOnlineStore_type2.json"},stg:{citytown:"//stgapis.senao.com.tw/apis/senao_online/EC_S3Resource.jsp?apiKey=API_taiwan_area.json",citytownstore:"//stgapis.senao.com.tw/apis/senao_online/EC_S3Resource.jsp?apiKey=APP_SenaoOnlineStore_type2.json"},prd:{citytown:"//apis.senao.com.tw/apis/senao_online/EC_S3Resource.jsp?apiKey=API_taiwan_area.json",citytownstore:"//apis.senao.com.tw/apis/senao_online/EC_S3Resource.jsp?apiKey=APP_SenaoOnlineStore_type2.json"}},this._init=function(){return f.settings.cityElement=t(this).find(f.settings.city),f.settings.townElement=t(this).find(f.settings.town),null!==f.settings.zip&&(f.settings.zipElement=t(this).find(f.settings.zip),f.settings.zip=f.settings.zipElement.length<=0?null:f.settings.zip),null!==f.settings.store&&(f.settings.storeElement=t(this).find(f.settings.store),f.settings.store=f.settings.storeElement.length<=0?null:f.settings.store),f.settings.cityElement.length<=0||f.settings.townElement.length<=0?(f.settings.debug&&console.log(f.settings.errorString.noElement,"city or town"),!1):(n._initData(),n._initOption(),n._initEvent(),n._initDefaultValue(),void f.settings.onReady(n,y[l]))},this._initData=function(){if(!(y[l].length<=0))return!1;var e;e=t.ajax({url:o[i][l],dataType:"json",async:!1}),e.done(function(t){y[l]=t[f.settings.storeType===!1?f.settings.island:"stores"],f.settings.debug&&console.log(y[l].length)}),e.fail(function(){return f.settings.debug&&console.log(f.settings.errorString.noConnect),!1})},this._initOption=function(){c=u="",d=m=0,a=y[l],g=f.settings.storeType===!1?y[l][d].districs:y[l][d].data,n.insertOption(f.settings.cityElement,a,"name",0),n.insertOption(f.settings.townElement,g,"name",1),f.settings.storeType===!0&&f.settings.storeElement.length>0?(p=y[l][d].data[m].data,n.insertOption(f.settings.storeElement,p,"storeName",2)):null!==f.settings.zipElement&&f.settings.zipElement.length>0&&(r=y[l][d].districs[m].zip_code,n.insertZip(f.settings.zipElement,r))},this._initEvent=function(){f.settings.cityElement.on("change",function(){n.getIndex("city"),g=f.settings.storeType===!1?y[l][d].districs:y[l][d].data,n.insertOption(f.settings.townElement,g,"name",1),f.settings.storeType===!0&&f.settings.storeElement.length>0?(p=y[l][d].data[m].data,n.insertOption(f.settings.storeElement,p,"storeName",2)):null!==f.settings.zipElement&&f.settings.zipElement.length>0&&(r=y[l][d].districs[m].zip_code,n.insertZip(f.settings.zipElement,r)),f.settings.onChange(this,c,a[d])}),f.settings.townElement.on("change",function(){n.getIndex("town"),f.settings.storeType===!0&&f.settings.storeElement.length>0?(p=y[l][d].data[m].data,n.insertOption(f.settings.storeElement,p,"storeName",2)):null!==f.settings.zipElement&&f.settings.zipElement.length>0&&(r=y[l][d].districs[m].zip_code,n.insertZip(f.settings.zipElement,r)),f.settings.onChange(this,u,g[m])}),f.settings.storeType===!0&&f.settings.storeElement.length>0&&f.settings.storeElement.on("change",function(){n.getIndex("store"),null!==f.settings.zipElement&&f.settings.zipElement.length>0&&(r=y[l][d].districs[m].zip_code,n.insertZip(f.settings.zipElement,r)),f.settings.onChange(this,E,p[h])})},this._initDefaultValue=function(){"undefined"!==f.settings.cityElement.data("val")&&f.settings.cityElement.find('option[value="'+f.settings.cityElement.data("val")+'"]').prop("selected",!0).trigger("change"),"undefined"!==f.settings.townElement.data("val")&&f.settings.townElement.find('option[value="'+f.settings.townElement.data("val")+'"]').prop("selected",!0).trigger("change"),f.settings.storeElement&&"undefined"!==f.settings.storeElement.data("val")&&f.settings.storeElement.find('option[value="'+f.settings.storeElement.data("val")+'"]').prop("selected",!0).trigger("change")},this.getIndex=function(t){return d=f.settings.cityElement.find("option:selected").index()||0,c=f.settings.cityElement.find("option:eq("+d+")").val()||"",d<0&&(d=0),m="city"===t?0:f.settings.townElement.find("option:selected").index()||0,u=f.settings.townElement.find("option:eq("+m+")").val()||"",m<0&&(m=0),h="city"===t||"town"===t||null===f.settings.store?0:f.settings.storeElement.find("option:selected").index()||0,E=null===f.settings.store?0:f.settings.storeElement.find("option:eq("+h+")").val()||"",h<0&&(h=0),{cityValue:c,cityIndex:d,townValue:u,townIndex:m,storeValue:E,storeIndex:h}},this.insertOption=function(e,n,s,i){"undefined"==typeof s&&(s="name"),"undefined"==typeof i&&(i=0);var o=t(e);return!(o.length<=0)&&(o.empty(),t.each(n,function(t,e){return o.append("<option value='"+e[s]+"' data-num='"+t+"' >"+e[s]+"</option>")}),0===o.find("option").length?o.append("<option value='' data-num='' data-store='' >尚無資料</option>"):void 0)},this.insertZip=function(e,n){return t(e).length<=0?(f.settings.debug&&console.log(f.settings.errorString.noElement,"zip"),!1):t(e)[t(e).is("input")?"val":"text"](n)},this._init(),f.settings.debug&&console.groupEnd(),this}}(jQuery);